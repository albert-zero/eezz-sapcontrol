/* ------------------------------------------------------------------------------- */                                                                                                                                                                          
/* Client WEB-Socket implementation                                                */                                                                                                                                                                          
                                                                                                                                                                                                                                                               
/* ------------------------------------------------------------------------------- */                                                                                                                                                                          
/* Variable declaration is generated by agent:                                                                                                                                                                                                                 
 * var gSocketAddr     = "ws://{}:{}";                                                                                                                                                                                                                         
 * var eezzWebSocket   = new WebSocket(gSocketAddr);                                                                                                                                                                                                           
 * var eezzArguments   = "";                                                                                                                                                                                                                                   
 */                                                                                                                                                                                                                                                            
var eezzWebSocket;                                                                                                                                                                                                                                             
var eezzArguments   = "";                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
document.onload = eezzConnect();                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
/* ------------------------------------------------------------------------------- */                                                                                                                                                                          
/* ------------------------------------------------------------------------------- */                                                                                                                                                                          
var eezzAgent = {                                                                                                                                                                                                                                              
    // Evaluates the elements for the callback functions                                                                                                                                                                                                       
    // ---------------------------------------------------------------------------                                                                                                                                                                             
    range : function ( rangeOperator, xElements ) {                                                                                                                                                                                                            
        var xList  = [];                                                                                                                                                                                                                                       
        var xMatch = null;                                                                                                                                                                                                                                     
        var xLen   = xElements.length;                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
 var i;                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
        if (rangeOperator == "[:]") {                                                                                                                                                                                                                          
            for (i = 0; i < xLen; i++) {                                                                                                                                                                                                                       
                xList.push( xElements[i] );                                                                                                                                                                                                                    
            }                                                                                                                                                                                                                                                  
            return xList;                                                                                                                                                                                                                                      
        }                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
        // match range operator                                                                                                                                                                                                                                
        xMatch = rangeOperator.match( /\x5B([0-9]+):([0-9]+)\x5d/ );                                                                                                                                                                                           
        if (xMatch) {                                                                                                                                                                                                                                          
            for (i = Math.min(0, xMatch[1]); i < Math.min(xLen, xMatch[2]); i++) {                                                                                                                                                                             
                xList.push( xElement[i] );                                                                                                                                                                                                                     
            }                                                                                                                                                                                                                                                  
            return xList;                                                                                                                                                                                                                                      
        }                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
        // match list operator                                                                                                                                                                                                                                 
        xMatch = rangeOperator.match( /\x5B([\d]+[,\s*\d+]*)\x5d/ );                                                                                                                                                                                           
        if (xMatch2) {                                                                                                                                                                                                                                         
            var xIntLst = xMatch2[1].split(",");                                                                                                                                                                                                               
            var xInx;                                                                                                                                                                                                                                          
            for (i = 0; i < xLen; i++) {                                                                                                                                                                                                                       
                if (i == parseInt( xIntList[i] )) {                                                                                                                                                                                                            
                    xList.push( xElement[i] );                                                                                                                                                                                                                 
                }                                                                                                                                                                                                                                              
            }                                                                                                                                                                                                                                                  
        }                                                                                                                                                                                                                                                      
    },                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
    // Script function to call user layout and animation                                                                                                                                                                                                       
    // -----                                                                                                                                                                                                                                                   
----------------------------------------------------------------------                                                                                                                                                                                         
    script: function( aJsonArg ) {                                                                                                                                                                                                                             
        var xContext  = null;                                                                                                                                                                                                                                  
        var xTable    = null;                                                                                                                                                                                                                                  
        var xElements = null;                                                                                                                                                                                                                                  
        var xTblBody  = null;                                                                                                                                                                                                                                  
        var xKey;                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
        // Find the target and setup the drawing context                                                                                                                                                                                                       
        if (aJsonArg.context.tagName == 'TABLE') {                                                                                                                                                                                                             
            xTable   = aJsonArg.context;                                                                                                                                                                                                                       
            xTblBody = xTable.getElementsByTagName('TBODY');                                                                                                                                                                                                   
            aJsonArg['current'] = {                                                                                                                                                                                                                            
                'header'  : xTable.getElementsByTagName('THEAD'),                                                                                                                                                                                              
                'footer'  : xTable.getElementsByTagName('TFOOT'),                                                                                                                                                                                              
                'context' : xTable.getElementsByTagName('TBODY'),                                                                                                                                                                                              
            };                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            xTable   = document.createElement('table');                                                                                                                                                                                                        
            xTable.innerHTML = aJsonArg.innerHTML;                                                                                                                                                                                                             
            xTblBody = xTable.getElementsByTagName('TBODY');                                                                                                                                                                                                   
            aJsonArg['updnew'] = {                                                                                                                                                                                                                             
                'header'  : xTable.getElementsByTagNa                                                                                                                                                                                                          
me('THEAD'),                                                                                                                                                                                                                                                   
                'footer'  : xTable.getElementsByTagName('TFOOT'),                                                                                                                                                                                              
                'context' : xTable.getElementsByTagName('TBODY'),                                                                                                                                                                                              
            };                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            if (aJsonArg.current.context.length == 0 ||                                                                                                                                                                                                        
                aJsonArg.updnew.context.length  == 0) {                                                                                                                                                                                                        
                return;                                                                                                                                                                                                                                        
            }                                                                                                                                                                                                                                                  
            aJsonArg.current.context  = aJsonArg.current.context[0];                                                                                                                                                                                           
            aJsonArg.current.elements = aJsonArg.current.context.getElementsByTagName('TD');                                                                                                                                                                   
                                                                                                                                                                                                                                                               
            aJsonArg.updnew.context   = aJsonArg.updnew.context[0];                                                                                                                                                                                            
            aJsonArg.updnew.filter    = aJsonArg.updnew.context.getElementsByTagName('TD');                                                                                                                                                                    
            aJsonArg.updnew.elements  = aJsonArg.updnew.filter;                                                                                                                                                                                                
                                                                                                                                                                                                                                                               
            // Update function could only called once for a given cycle                                                                                                                                                                                        
            aJsonArg['update'] = (                                                                                                                                                                                                                             
                function(aJsonContext) {                                                                                                                                                                                                                       
                    var aDone = false;                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
                    return function                                                                                                                                                                                                                            
() {                                                                                                                                                                                                                                                           
                        if (aDone) {                                                                                                                                                                                                                           
                            return;                                                                                                                                                                                                                            
                        }                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
                        var xParent = aJsonContext.current.context.parentNode;                                                                                                                                                                                 
                        xParent.replaceChild(aJsonContext.updnew.context, aJsonContext.current.context);                                                                                                                                                       
                        // aJsonContext.current.context.replaceWith(aJsonContext.updnew.context);                                                                                                                                                              
                                                                                                                                                                                                                                                               
                        if (aJsonContext.current.header.length  > 0 && aJsonContext.updnew.header.length  > 0) {                                                                                                                                               
                            xParent = aJsonContext.current.header[0].parentNode;                                                                                                                                                                               
                            xParent.replaceChild(aJsonContext.updnew.header[0], aJsonContext.current.header[0]);                                                                                                                                               
                            // aJsonContext.current.header[0].replaceWidth(aJsonContext.updnew.header[0]);                                                                                                                                                     
                        }                                                                                                                                                                                                                                      
                        if (aJsonContext.current.footer.length  > 0 && aJsonContext.updnew.footer.length  > 0) {                                                                                                                                               
                                                                                                                                                                                                                                                               
              xParent = aJsonContext.current.footer[0].parentNode;                                                                                                                                                                                             
                            xParent.replaceChild(aJsonContext.updnew.footer[0], aJsonContext.current.footer[0]);                                                                                                                                               
                            // aJsonContext.current.footer[0].replaceWith(aJsonContext.updnew.footer[0]);                                                                                                                                                      
                        }                                                                                                                                                                                                                                      
                        aJsonContext.current.elements.length = 0;                                                                                                                                                                                              
                        aDone = true;                                                                                                                                                                                                                          
                    }                                                                                                                                                                                                                                          
                }                                                                                                                                                                                                                                              
            ) (aJsonArg);                                                                                                                                                                                                                                      
        }                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
        // Find the scripting modules                                                                                                                                                                                                                          
        for (xKey in aJsonArg.script) {                                                                                                                                                                                                                        
            var xPos = xKey.search("\\[");                                                                                                                                                                                                                     
            if (xPos < 0) {                                                                                                                                                                                                                                    
                continue;                                                                                                                                                                                                                                      
            }                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
            var xCommand  = xKey.substr(0, xPos);                                                                                                                                                                                                              
            var xCmdRange = xKey.substr(xPos);                                                                                                                                                                                                                 
            var xCmdArgs  = aJsonArg.script[ xKey ];                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
            // evaluate range                                                                                                                                                                                                                                  
            // aJsonArg.updnew.elements = this.range( xCmdRange, aJsonArg.updnew.filter );                                                                                                                                                                     
                                                                                                                                                                                                                                                               
      // Collect generators into                                                                                                                                                                                                                               
            // aJsonArg.script[xKey].generator = ....                                                                                                                                                                                                          
            // In runAnimation: Loop at aJsonArg.script and look for generators                                                                                                                                                                                
            if (xCommand == "eezzAgent.animated_circle") {                                                                                                                                                                                                     
                var aGenerator = eezzAgent.animated_circle( aJsonArg, xCmdArgs );                                                                                                                                                                              
                eezzAgent.runAnimation( new Date().getTime(), aGenerator, xCmdArgs );                                                                                                                                                                          
                // this.circle( xJsonArgs );                                                                                                                                                                                                                   
            }                                                                                                                                                                                                                                                  
            else if (xCommand == "eezzAgent.move") {                                                                                                                                                                                                           
                // Move elements                                                                                                                                                                                                                               
            }                                                                                                                                                                                                                                                  
            else {                                                                                                                                                                                                                                             
                try {                                                                                                                                                                                                                                          
                    // var xxobj = eval("( myOwn.circle )");                                                                                                                                                                                                   
                    // var xxobj     = window["myOwn"];                                                                                                                                                                                                        
                   //  xxobj.circle( xJsonArgs );                                                                                                                                                                                                              
               } catch (e) {                                                                                                                                                                                                                                   
                   alert(e.message);                                                                                                                                                                                                                           
               }                                                                                                                                                                                                                                               
            }                                                                                                                                                                                                                                                  
        }                                                                                                                                                                                                                                                      
    },                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
    // ---------------------------------------------------------------------------                                                                                                                                                                             
    // Run animation                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
    // The yield returns the timeout for the next call                                                                                                                                                                                                         
    // If the yield is a negative number, the method would request the animation                                                                                                                                                                               
    // frame.                                                                                                                                                                                                                                                  
    // ---------------------------------------------------------------------------                                                                                                                                                                             
    runAnimation: function( timestamp, aGenerator, xCmdArgs ) {                                                                                                                                                                                                
        var xResult = aGenerator.next();                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
        if (!xResult.done) {                                                                                                                                                                                                                                   
            var xTimer = parseInt(xResult.value);                                                                                                                                                                                                              
            if (isNaN(xTimer)) {                                                                                                                                                                                                                               
                return;                                                                                                                                                                                                                                        
            }                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
            if (xTimer >= 0) {                                                                                                                                                                                                                                 
                window.setTimeout( function(){ eezzAgent.runAnimation(timestamp, aGenerator, xCmdArgs); }, xTimer );                                                                                                                                           
            }                                                                                                                                                                                                                                                  
            else  {                                                                                                                                                                                                                                            
                requestAnimationFrame( function(timestamp){ runAnimation(timestamp, aGenerator, xCmdArgs); } );                                                                                                                                                
            }                                                                                                                                                                                                                                                  
        }                                                                                                                                                                                                                                                      
    },                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
    // ---------------------------------------------------------------------------                                                                                                                                                                             
    // --------------------------------------------------------------------------                                                                                                                                                                              
-                                                                                                                                                                                                                                                              
    getSize: function( aElement ) {                                                                                                                                                                                                                            
        var xWidth  = parseInt( aElement.style.width  );                                                                                                                                                                                                       
        var xHeight = parseInt( aElement.style.height );                                                                                                                                                                                                       
        var xStyle  = getComputedStyle( aElement );                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
        if (isNaN(xWidth)) {                                                                                                                                                                                                                                   
            xWidth  = parseInt( xStyle.getPropertyValue("width") );                                                                                                                                                                                            
        }                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
        if (isNaN(xHeight)) {                                                                                                                                                                                                                                  
            xWidth  = parseInt( xStyle.getPropertyValue("height") );                                                                                                                                                                                           
        }                                                                                                                                                                                                                                                      
        return {'width':xWidth, 'height': xHeight};                                                                                                                                                                                                            
    },                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
    // ---------------------------------------------------------------------------                                                                                                                                                                             
    // ---------------------------------------------------------------------------                                                                                                                                                                             
    getMaxSize: function( aElemList ) {                                                                                                                                                                                                                        
        var i;                                                                                                                                                                                                                                                 
        var xWidth  = 40;                                                                                                                                                                                                                                      
        var xHeigth = 40;                                                                                                                                                                                                                                      
        var xResult;                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
        for (i = 0; i < aElemList.length; i++) {                                                                                                                                                                                                               
            xResult = parseInt( aElemList[i].style.width );                                                                                                                                                                                                    
            if (!isNaN(xResult)) {                                                                                                                                                                                                                             
                xW                                                                                                                                                                                                                                             
idth = Math.max( xResult, xWidth );                                                                                                                                                                                                                            
            }                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
            xResult = parseInt( aElemList[i].style.height );                                                                                                                                                                                                   
            if (!isNaN(xResult)) {                                                                                                                                                                                                                             
                xHeight = Math.max( xResult,  xHeigth );                                                                                                                                                                                                       
            }                                                                                                                                                                                                                                                  
        }                                                                                                                                                                                                                                                      
        return {'width':xWidth, 'height': xHeigth};                                                                                                                                                                                                            
    },                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
    // ---------------------------------------------------------------------------                                                                                                                                                                             
    // ---------------------------------------------------------------------------                                                                                                                                                                             
    getGeometry: function( xCmdArgs, aContext, aElements ) {                                                                                                                                                                                                   
        if (aElements.length == 0) {                                                                                                                                                                                                                           
            return {};                                                                                                                                                                                                                                         
        }                                                                                                                                                                                                                                                      
        var xViewport = this.getSize( aContext );                                                                                                                                                                                                              
        var xElemSize = this.getMaxSize( aElements );                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
        var xGeometry = {                                                                                                                                                                                                                                      
            viewport: xViewport,                                                                                                                                                                                                                               
            element : xElemSize,                                                                                                                                                                                                                               
            deltaPhi: 2 * Math.PI / aElements.length,                                                                                                                                                                                                          
            center  : {                                                                                                                                                                                                                                        
                x: xViewport.width / 2.0,                                                                                                                                                                                                                      
                y: xViewport.height/ 2.0                                                                                                                                                                                                                       
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
  radius  : {                                                                                                                                                                                                                                                  
                x: xViewport.width / 2.0 - xElemSize.width / 2.0,                                                                                                                                                                                              
                y: xViewport.height/ 2.0 - xElemSize.height/ 2.0                                                                                                                                                                                               
            },                                                                                                                                                                                                                                                 
            offset  : {                                                                                                                                                                                                                                        
                x: - xElemSize.width / 2.0,                                                                                                                                                                                                                    
                y: - xElemSize.height/ 2.0                                                                                                                                                                                                                     
            }                                                                                                                                                                                                                                                  
        }                                                                                                                                                                                                                                                      
        return xGeometry;                                                                                                                                                                                                                                      
    },                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
    // ---------------------------------------------------------------------------                                                                                                                                                                             
    // layout function to put all elements on a circle                                                                                                                                                                                                         
    // ---------------------------------------------------------------------------                                                                                                                                                                             
    circle: function* ( xJsonArgs, xCmdArgs ) {                                                                                                                                                                                                                
        var i, j, k;                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
        xJsonArgs.update();                                                                                                                                                                                                                                    
        var xElements = xJsonArgs.updnew.elements;                                                                                                                                                                                                             
        if (xElements.length > 0) {                                                                                                                                                                                                                            
            var xGeometry = this.getGeometry(xCmdArgs, xJsonArgs.updnew.context, xElements);                                                                                                                                                                   
            for (i = 0; i < xElements.length; i++) {                                                                                                                                                                                                           
                for (j = xElements.length - i - 1, k = 0; j < xElements.length; j++, k++) {                                                                                                                                                                    
                                                                                                                                                                                                                                                               
  xElements[j].style.left = ( xGeometry.center.x + xGeometry.radius.x * Math.cos(k * xGeometry.deltaPhi) + xGeometry.offset.x ) + "px";                                                                                                                        
                    xElements[j].style.top  = ( xGeometry.center.y + xGeometry.radius.y * Math.sin(k * xGeometry.deltaPhi) + xGeometry.offset.y ) + "px";                                                                                                      
                }                                                                                                                                                                                                                                              
            }                                                                                                                                                                                                                                                  
        }                                                                                                                                                                                                                                                      
    },                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
    // ---------------------------------------------------------------------------                                                                                                                                                                             
    // layout function to put all elements on a circle                                                                                                                                                                                                         
    // ---------------------------------------------------------------------------                                                                                                                                                                             
    animated_circle: function* ( xJsonArgs, xCmdArgs ) {                                                                                                                                                                                                       
        var i, j, k;                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
        var xElements = xJsonArgs.current.elements;                                                                                                                                                                                                            
        if (xElements.length > 0) {                                                                                                                                                                                                                            
            var xGeometry = this.getGeometry(xCmdArgs, xJsonArgs.current.context, xElements);                                                                                                                                                                  
                                                                                                                                                                                                                                                               
            for (i = 0; i < xElements.length; i++) {                                                                                                                                                                                                           
                // xElements[i].parentElement.removeChild( xElements[i] );                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
      for (j = i + 1, k = 0; j < xElements.length; j++, k++) {                                                                                                                                                                                                 
                    xElements[j].style.left = ( xGeometry.center.x + xGeometry.radius.x * Math.cos(k * xGeometry.deltaPhi) + xGeometry.offset.x ) + "px";                                                                                                      
                    xElements[j].style.top  = ( xGeometry.center.y + xGeometry.radius.y * Math.sin(k * xGeometry.deltaPhi) + xGeometry.offset.y ) + "px";                                                                                                      
                    xElements[j].style.transition = "all " + 0.1 + "s";                                                                                                                                                                                        
                }                                                                                                                                                                                                                                              
                yield 100;                                                                                                                                                                                                                                     
            }                                                                                                                                                                                                                                                  
        }                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
        xJsonArgs.update();                                                                                                                                                                                                                                    
        var xElements = xJsonArgs.updnew.elements;                                                                                                                                                                                                             
        if (xElements.length > 0) {                                                                                                                                                                                                                            
            var xGeometry = this.getGeometry(xCmdArgs, xJsonArgs.updnew.context, xElements);                                                                                                                                                                   
                                                                                                                                                                                                                                                               
            // Prepare                                                                                                                                                                                                                                         
            for (i = 0; i < xElements.length; i++) {                                                                                                                                                                                                           
                xElements[i].style.position = "absolute";                                                                                                                                                                                                      
                xElements[i].style.left = ( xGeometry.center.x + xGeometry.offset.x + xGeometry.radius.x                                                                                                                                                       
) + "px";                                                                                                                                                                                                                                                      
                xElements[i].style.top  = ( xGeometry.center.y + xGeometry.offset.y ) + "px";                                                                                                                                                                  
                xElements[i].style.transition = "all " + 0.1 + "s";                                                                                                                                                                                            
                xElements[i].style.physics    = {                                                                                                                                                                                                              
                        "velocity": (2 * Math.PI * xGeometry.radius.x)/1000,                                                                                                                                                                                   
                        "phi"     : 0,                                                                                                                                                                                                                         
                        "delay"   : i * 1000 / xElements.length }                                                                                                                                                                                              
            }                                                                                                                                                                                                                                                  
            yield 0;                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
            // Set position and wait for animation                                                                                                                                                                                                             
            for (i = 0; i < xElements.length; i++) {                                                                                                                                                                                                           
                for (j = xElements.length - i - 1, k = 0; j < xElements.length; j++, k++) {                                                                                                                                                                    
                    xElements[j].style.left = ( xGeometry.center.x + xGeometry.radius.x * Math.cos(k * xGeometry.deltaPhi) + xGeometry.offset.x ) + "px";                                                                                                      
                    xElements[j].style.top  = ( xGeometry.center.y + (xGeometry.radius.y-20) * Math.sin(k * xGeometry.deltaPhi) + xGeometry.offset.y ) + "px";                                                                                                 
                }                                                                                                                                                                                                                                              
                y                                                                                                                                                                                                                                              
ield 100;                                                                                                                                                                                                                                                      
            }                                                                                                                                                                                                                                                  
        }                                                                                                                                                                                                                                                      
        else {                                                                                                                                                                                                                                                 
            return;                                                                                                                                                                                                                                            
        }                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
        var xBackgrd = "";                                                                                                                                                                                                                                     
        try {                                                                                                                                                                                                                                                  
            var xGeometry = this.getGeometry(xCmdArgs, xJsonArgs.updnew.context, xElements);                                                                                                                                                                   
            var aCanvas   = document.createElement("canvas");;                                                                                                                                                                                                 
            aCanvas.width  = xGeometry.center.x * 2;                                                                                                                                                                                                           
            aCanvas.height = xGeometry.center.x * 2;                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
            var aCtx = aCanvas.getContext('2d');                                                                                                                                                                                                               
            aCtx.arc(xGeometry.center.x, xGeometry.center.y, Math.min(xGeometry.radius.x, xGeometry.radius.y) + 20, 0, 2 * Math.PI);                                                                                                                           
            aCtx.lineWidth = 5;                                                                                                                                                                                                                                
            // aCtx.fillStyle = 'green';                                                                                                                                                                                                                       
            // aCtx.fill();                                                                                                                                                                                                                                    
            aCtx.strokeStyle = '#003300';                                                                                                                                                                                                                      
            aCtx.stroke();                                                                                                                                                                                                                                     
            xBackgrd = "url('"  + aCanvas.toDataURL() + "') no-repeat top left";                                                                                                                                                                               
            xJsonArgs.updnew.context.style.background = xBackgrd;                                                                                                                                                                                              
        }                                                                                                                                                                                                                                                      
        catch( xEx ) {                                                                                                                                                                                                                                         
            xBackgrd = xEx.message;                                                                                                                                                                                                                            
        }                                                                                                                                                                                                                                                      
    },                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
 // ---------------------------------------------------------------------------                                                                                                                                                                                
    // layout function to put all elements on a circle                                                                                                                                                                                                         
    // ---------------------------------------------------------------------------                                                                                                                                                                             
    /*                                                                                                                                                                                                                                                         
     *                                                                                                                                                                                                                                                         
     animated_physic: function* ( xJsonArgs, xCmdArgs ) {                                                                                                                                                                                                      
        var i, j, k;                                                                                                                                                                                                                                           
        var xStart    = new Date().getTime();                                                                                                                                                                                                                  
        var xTime     = 0;                                                                                                                                                                                                                                     
        var xInterval = 0;                                                                                                                                                                                                                                     
        var xDuration = 0;                                                                                                                                                                                                                                     
        var deltaPhi  = 0;                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        xJsonArgs.update();                                                                                                                                                                                                                                    
        var xElements = xJsonArgs.updnew.elements;                                                                                                                                                                                                             
        if (xElements.length == 0) {                                                                                                                                                                                                                           
            return;                                                                                                                                                                                                                                            
        }                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
        // Prepare                                                                                                                                                                                                                                             
        var xGeometry = this.getGeometry(xCmdArgs, xJsonArgs.updnew.context, xElements);                                                                                                                                                                       
        for (i = 0; i < xElements.length; i++) {                                                                                                                                                                                                               
            xElements[i].style.position = "absolute";                                                                                                                                                                                                          
            xElements[i].style.left = ( xGeometry.center.x + xGeometry.offset.x + xGeometry.radius.x) + "px";                                                                                                                                                  
                                                                                                                                                                                                                                                               
xElements[i].style.top  = ( xGeometry.center.y + xGeometry.offset.y ) + "px";                                                                                                                                                                                  
            xElements[i].style.physics  = {                                                                                                                                                                                                                    
                    "velocity": (2 * Math.PI * xGeometry.radius.x)/1000,                                                                                                                                                                                       
                    "phi"     : 0,                                                                                                                                                                                                                             
                    "delay"   : i * 1000 / xElements.length }                                                                                                                                                                                                  
            }                                                                                                                                                                                                                                                  
        }                                                                                                                                                                                                                                                      
        yield -1;                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
        // Set position and wait for animation                                                                                                                                                                                                                 
        for (i = 0; i < xElements.length; i++) {                                                                                                                                                                                                               
            xTime      = new Date().getTime();                                                                                                                                                                                                                 
            xInterval  = xTime - xStart;                                                                                                                                                                                                                       
            xStart     = xTime;                                                                                                                                                                                                                                
            xDuration += xInterval;                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
            if (xElements[i].physics.delay < xDuration) {                                                                                                                                                                                                      
                continue;                                                                                                                                                                                                                                      
            }                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
            if (xDuration > 1000) {                                                                                                                                                                                                                            
                break;                                                                                                                                                                                                                                         
            }                                                                                                                                                                                                                                                  
            xElements[i].style.physics.phi += xElements[i].style.physics.velocity * xInterval;                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            xElements[j].style.left = ( xGeometry.center.x + xGeometry.radius.x      * Math.c                                                                                                                                                                  
os(xElements[i].style.physics.phi) + xGeometry.offset.x ) + "px";                                                                                                                                                                                              
            xElements[j].style.top  = ( xGeometry.center.y + (xGeometry.radius.y-20) * Math.sin(xElements[i].style.physics.phi) + xGeometry.offset.y ) + "px";                                                                                                 
            yield -1;                                                                                                                                                                                                                                          
        }                                                                                                                                                                                                                                                      
    }*/                                                                                                                                                                                                                                                        
}                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
/* ------------------------------------------------------------------------------- */                                                                                                                                                                          
/* ------------------------------------------------------------------------------- */                                                                                                                                                                          
function eezzConnect() {                                                                                                                                                                                                                                       
    eezzWebSocket   = new WebSocket(gSocketAddr);                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
    eezzWebSocket.onopen = function() {                                                                                                                                                                                                                        
        var aParser   = document.createElement('a');                                                                                                                                                                                                           
        aParser.href  = document.URL;                                                                                                                                                                                                                          
        var aJson     = {"path": aParser.pathname, "args": eezzArguments};                                                                                                                                                                                     
        var aDocStr   = document.documentElement.innerHTML;                                                                                                                                                                                                    
        var aBodyPos  = aDocStr.indexOf("<body");                                                                                                                                                                                                              
        var aJson     = {"path": aParser.pathname, "args": eezzArguments, "document": aDocStr.substr(aBodyPos)};                                                                                                                                               
                                                                                                                                                                                                                                                               
        eezzWebSoc                                                                                                                                                                                                                                             
ket.send(JSON.stringify(aJson));                                                                                                                                                                                                                               
    }                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
    /* Error handling */                                                                                                                                                                                                                                       
    /* --------------------------------- */                                                                                                                                                                                                                    
    eezzWebSocket.onerror = function(aError) {                                                                                                                                                                                                                 
        xEezzStatus = document.getElementById( "eezzConnection" );                                                                                                                                                                                             
        if (xEezzStatus != null) {                                                                                                                                                                                                                             
            xEezzStatus.style.display = "none";                                                                                                                                                                                                                
        }                                                                                                                                                                                                                                                      
        xEezzStatus = document.getElementById( "eezzConnectBrk" );                                                                                                                                                                                             
        if (xEezzStatus != null) {                                                                                                                                                                                                                             
            xEezzStatus.style.display = "inline";                                                                                                                                                                                                              
        }                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
    }                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
    /* Wait for the application and update the document          */                                                                                                                                                                                            
    /* - updateValues transfer values within the document        */                                                                                                                                                                                            
    /* - update inserts values calculated by application         */                                                                                                                                                                                            
    /* --------------------------------------------------------- */                                                                                                                                                                                            
    eezzWebSocket.onmessage = function(aEvent) {                                                                                                                                                                                                               
        var aJson = eval("(" + aEvent.data + ")");                                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
        var xDestination;                                                                                                                                                                                                                                      
        var xSource;                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
        var xValElement;                                                                                                                                                                                                                                       
        var xDstElement;                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
        var xDstAttribute;                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        var xSrcElement;                                                                                                                                                                                                                                       
        var xSrcAttribute;                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        var xValue;                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
        /* update fragments: transfer values within document */                                                                                                                                                                                                
        for (xKeyElement in aJson.updateValue) {                                                                                                                                                                                                               
            xValElement   = decodeURIComponent( aJson.updateValue[xKeyElement] );                                                                                                                                                                              
                                                                                                                                                                                                                                                               
            xDestination  = xKeyElement.split(".");                                                                                                                                                                                                            
            xSource       = xValElement.split('.')                                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
            if (xDestination.length != 2) {                                                                                                                                                                                                                    
                continue;                                                                                                                                                                                                                                      
            }                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
            xDstElement   = document.getElementsByName( xDestination[0] );                                                                                                                                                                                     
            xDstAttribute = xDestination[1];                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
            if (xDstElement.length == 0) {                                                                                                                                                                                                                     
                continue;                                                                                                                                                                                                                                      
            }                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
            if (xSource.length != 2) {                                                                                                                                                                                                                         
                continue;                                                                                                                                                                                                                                      
            }                                                                                                                                                                                                                                                  
            xSrcElement   = document.getElementsByName(xSource[0]);                                                                                                                                                                                            
            xSrcAttribute = xSource[1];                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
            if (xSrcE                                                                                                                                                                                                                                          
lement.length == 0) {                                                                                                                                                                                                                                          
                continue;                                                                                                                                                                                                                                      
            }                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
            xValue = xSrcElement[0].getAttribute(xSrcAttribute);                                                                                                                                                                                               
            if (xValue != undefined) {                                                                                                                                                                                                                         
                xDstElement[0].setAttribute(xDstAttribute, xValue);                                                                                                                                                                                            
            }                                                                                                                                                                                                                                                  
        }                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
        /* update fragments: insert values */                                                                                                                                                                                                                  
        for (xKeyElement in aJson.update) {                                                                                                                                                                                                                    
            if (xKeyElement.endsWith('.script')) {                                                                                                                                                                                                             
                xDestination  = xKeyElement.split('.');                                                                                                                                                                                                        
                var xKeyHtml  = xDestination[0] + '.innerHTML';                                                                                                                                                                                                
                var xJsonArg  = {};                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                xDstElement   = document.getElementsByName( xDestination[0] );                                                                                                                                                                                 
                if (xDstElement.length == 0) {                                                                                                                                                                                                                 
                    break;                                                                                                                                                                                                                                     
                }                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                xJsonScript = JSON.parse( decodeURIComponent( aJson.update[xKeyElement] ));                                                                                                                                                                    
                xJsonArg    = {                                                                                                                                                                                                                                
                    'name'   : xDestination[0],                                                                                                                                                                                                                
                    'context': xDstElement[0],                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
                   'script' : xJsonScript  };                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
                delete aJson.update[xKeyElement];                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                if (aJson.update[xKeyHtml]) {                                                                                                                                                                                                                  
                    xJsonArg['innerHTML'] = decodeURIComponent( decodeURIComponent( aJson.update[xKeyHtml] ));                                                                                                                                                 
                    delete aJson.update[xKeyHtml];                                                                                                                                                                                                             
                }                                                                                                                                                                                                                                              
                eezzAgent.script( xJsonArg );                                                                                                                                                                                                                  
                break;                                                                                                                                                                                                                                         
            }                                                                                                                                                                                                                                                  
        }                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
        /* update fragments: insert values */                                                                                                                                                                                                                  
        for (xKeyElement in aJson.update) {                                                                                                                                                                                                                    
            xValElement   = decodeURIComponent( aJson.update[xKeyElement] );                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
            xDestination  = xKeyElement.split(".");                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
            if (xDestination.length < 2) {                                                                                                                                                                                                                     
                continue;                                                                                                                                                                                                                                      
            }                                                                                                                                                                                                                                                  
            xDstElement   = document.getElementsByName( xDestination[0] );                                                                                                                                                                                     
            xDstAttribute = xDestination[1];                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
            if (xDstElement.length == 0) {                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
         continue;                                                                                                                                                                                                                                             
            }                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
            if (xDstAttribute == 'style') {                                                                                                                                                                                                                    
                if (xDestination.length > 2) {                                                                                                                                                                                                                 
                    xDstElement[0].style[xDestination[2]] = xValElement;                                                                                                                                                                                       
                }                                                                                                                                                                                                                                              
                continue;                                                                                                                                                                                                                                      
            }                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
            if (xDstAttribute == 'data-eezz-script') {                                                                                                                                                                                                         
                try {                                                                                                                                                                                                                                          
                    eezzAgent.script( xValElement );                                                                                                                                                                                                           
                } catch (aEx) {                                                                                                                                                                                                                                
                }                                                                                                                                                                                                                                              
                continue;                                                                                                                                                                                                                                      
            }                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
            if (xKeyElement.indexOf('innerHTML') >= 0) {                                                                                                                                                                                                       
                var xClassAttr = xDstElement[0].getAttribute('class');                                                                                                                                                                                         
                if (xClassAttr != null &&                                                                                                                                                                                                                      
                    xClassAttr.indexOf('eezzTreeNode') >= 0 &&                                                                                                                                                                                                 
                    xDstElement[0].nodeName == 'TR') {                                                                                                                                                                                                         
                    eezzTreeInsert(xDestination[0], xValElement);                                                                                                                                                                                              
                }                                                                                                                                                                                                                                              
                else {                                                                                                                                                                                                                                         
                    xDstElement[0].innerHTML = xValElement;                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
           }                                                                                                                                                                                                                                                   
            }                                                                                                                                                                                                                                                  
            else {                                                                                                                                                                                                                                             
                xDstElement[0].setAttribute(xDstAttribute, xValElement);                                                                                                                                                                                       
            }                                                                                                                                                                                                                                                  
        }                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
        /* Start reading files */                                                                                                                                                                                                                              
        if (aJson.files) {                                                                                                                                                                                                                                     
            readFiles(aJson);                                                                                                                                                                                                                                  
        }                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
        xEezzStatus   = document.getElementById( "eezzConnected" );                                                                                                                                                                                            
        if (xEezzStatus != null) {                                                                                                                                                                                                                             
            xEezzStatus.innerHTML = "connected";                                                                                                                                                                                                               
        }                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
    }                                                                                                                                                                                                                                                          
}                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
/* --------------------------------- */                                                                                                                                                                                                                        
/* --------------------------------- */                                                                                                                                                                                                                        
function eezzTreeExCo(aElement) {                                                                                                                                                                                                                              
    var xExpanded;                                                                                                                                                                                                                                             
    var xTreeHead;                                                                                                                                                                                                                                             
    var xTreeBody;                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
    xTreeHead = aElement.getElementsByClassName('eezzTreeHead');                                                                                                                                                                                               
    xTreeBody = aElement.getElementsByClassName('eezzTreeBody');                                                                                                                                                                                               
    xExpanded = aElement.getAttribute('eezz-tree-expanded');                                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
    var  xFlipElements;                                                                                                                                                                                                                                        
    var  xInx;                                                                                                                                                                                                                                                 
    xFlipElements = aElement.getElementsByClassName('eezzClosed');                                                                                                                                                                                             
    for (xInx = 0; xInx < xFlipElements.length; xInx++) {                                                                                                                                                                                                      
    	xFlipElemen                                                                                                                                                                                                                                               
ts[xInx].style.display = 'initial';                                                                                                                                                                                                                            
    }                                                                                                                                                                                                                                                          
    xFlipElements = aElement.getElementsByClassName('eezzOpend');                                                                                                                                                                                              
    for (xInx = 0; xInx < xFlipElements.length; xInx++) {                                                                                                                                                                                                      
    	xFlipElements[xInx].style.display = 'none';                                                                                                                                                                                                               
    }                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
    if (xExpanded == 'expanded') {                                                                                                                                                                                                                             
        aElement.innerHTML = xTreeHead[0].innerHTML;                                                                                                                                                                                                           
        aElement.setAttribute('eezz-tree-expanded', 'collapsed');                                                                                                                                                                                              
        return false;                                                                                                                                                                                                                                          
    }                                                                                                                                                                                                                                                          
    else {                                                                                                                                                                                                                                                     
        return true;                                                                                                                                                                                                                                           
    }                                                                                                                                                                                                                                                          
}                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
/* --------------------------------- */                                                                                                                                                                                                                        
/* --------------------------------- */                                                                                                                                                                                                                        
function eezzTreeInsert(aElementId, aNodeElement) {                                                                                                                                                                                                            
    // Find tree node by id tag element tr                                                                                                                                                                                                                     
    var aElement     = document.getElementsByName(aElementId)[0];                                                                                                                                                                                              
    var xExpanded    = aElement.getAttribute('eezz-tree-expanded');                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
    if (xExpanded == 'expanded') {                                                                                                                                                                                                                             
        eezzTreeExCo(aElement);                                                                                                                                                                                                                                
    }                                                                                                                                                                                                                                                          
    if (aElement.nodeName != 'TR') {                                                                                                                                                                                                                           
        return;                                                                                                                                                                                                                                                
    }                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
    // The new element should take the entire place                                                                                                                                                                                                            
    var aCols = aElement.getElements                                                                                                                                                                                                                           
ByTagName('td').length.toString()                                                                                                                                                                                                                              
    // Save the header and clear element for new entry                                                                                                                                                                                                         
    var aTreeNodeHdr = aElement.innerHTML;                                                                                                                                                                                                                     
    var aBodyInx     = aNodeElement.indexOf('<tbody');                                                                                                                                                                                                         
    aElement.innerHTML = '';                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
    // Create a new entry                                                                                                                                                                                                                                      
    var xTd         = document.createElement('td');                                                                                                                                                                                                            
    var xTableHead  = document.createElement('table');                                                                                                                                                                                                         
    var xTableBody  = document.createElement('table');                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
    xTableHead.innerHTML = aTreeNodeHdr;                                                                                                                                                                                                                       
    xTableBody.innerHTML = aNodeElement.substr(aBodyInx);                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
    xTd.setAttribute('colspan', aCols);                                                                                                                                                                                                                        
    xTd.appendChild(xTableHead);                                                                                                                                                                                                                               
    xTd.appendChild(xTableBody);                                                                                                                                                                                                                               
    aElement.appendChild(xTd);                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
    xTableHead.setAttribute('class', 'eezzTreeHead');                                                                                                                                                                                                          
    xTableBody.setAttribute('class', 'eezzTreeBody');                                                                                                                                                                                                          
    aElement.setAttribute('eezz-tree-expanded', 'expanded');                                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
    var  xFlipElements;                                                                                                                                                                                                                                        
    var  xInx;                                                                                                                                                                                                                                                 
    xFlipElements = xTableHead.getElementsByClassName('eezzClosed');                                                                                                                                                                                           
    for (xInx = 0; xInx <                                                                                                                                                                                                                                      
 xFlipElements.length; xInx++) {                                                                                                                                                                                                                               
    	xFlipElements[xInx].style.display = 'none';                                                                                                                                                                                                               
    }                                                                                                                                                                                                                                                          
    xFlipElements = xTableHead.getElementsByClassName('eezzOpend');                                                                                                                                                                                            
    for (xInx = 0; xInx < xFlipElements.length; xInx++) {                                                                                                                                                                                                      
    	xFlipElements[xInx].style.display = 'initial';                                                                                                                                                                                                            
    }                                                                                                                                                                                                                                                          
}                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
/* Read one file in chunks           */                                                                                                                                                                                                                        
/* --------------------------------- */                                                                                                                                                                                                                        
function readOneFile(aHeader, aFile) {                                                                                                                                                                                                                         
    var aChunkSize = aHeader.chunkSize;                                                                                                                                                                                                                        
    var aSequence  = 0;                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
    for (var i = 0; i < aFile.size; i += aChunkSize) {                                                                                                                                                                                                         
        (function(xHeader, xFile, xStart) {                                                                                                                                                                                                                    
            var aCurrentChunk = Math.min(aChunkSize, xFile.size - xStart);                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
            var aReader = new FileReader();                                                                                                                                                                                                                    
            var aBlob   = xFile.slice(xStart, xStart + aChunkSize);                                                                                                                                                                                            
            var xJson   = xHeader;                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
            xJson.file.start     = xStart;                                                                                                                                                                                                                     
            xJson.file.chunkSize = aCurrentChunk;                                                                                                                                                                                                              
            xJson.file.sequence  = aSequence;                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
            aReader.onloa                                                                                                                                                                                                                                      
dend  = (                                                                                                                                                                                                                                                      
                function(xOneJson) {                                                                                                                                                                                                                           
                    return function(e) {                                                                                                                                                                                                                       
                    };                                                                                                                                                                                                                                         
                } )(xJson);                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
            aReader.onprogress  = (                                                                                                                                                                                                                            
                function(xOneJson) {                                                                                                                                                                                                                           
                    return function(e) {                                                                                                                                                                                                                       
                    };                                                                                                                                                                                                                                         
                } )(xJson);                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
            aReader.onload   = (                                                                                                                                                                                                                               
                function(xOneJson) {                                                                                                                                                                                                                           
                    var xResponse = JSON.stringify(xOneJson);                                                                                                                                                                                                  
                    return function(e) {                                                                                                                                                                                                                       
                        eezzWebSocket.send(xResponse);                                                                                                                                                                                                         
                        eezzWebSocket.send(e.target.result);                                                                                                                                                                                                   
                    };                                                                                                                                                                                                                                         
                } )(xJson);                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
            aReader.readAsArrayBuffer(aBlob);                                                                                                                                                                                                                  
        } )(aHeader, aFile, i);                                                                                                                                                                                                                                
        aSequence += 1;                                                                                                                                                                                                                                        
    }                                                                                                                                                                                                                                                          
}                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
/* Read files                        */                                                                                                                                                                                                                        
/* --------------------------------- */                                                                                                                                                                                                                        
function readFiles(aHeader) {                                                                                                                                                                                                                                  
    asyncFileCnt      = 0;                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
    for (var i = 0; i < aHeader[                                                                                                                                                                                                                               
"files"].length; i++) {                                                                                                                                                                                                                                        
        aElem       = document.getElementsByName(aHeader["files"][i]["source"])[0];                                                                                                                                                                            
                                                                                                                                                                                                                                                               
        for (var j = 0; j < aElem.files.length; j++) {                                                                                                                                                                                                         
            var xFile   = aElem.files[j];                                                                                                                                                                                                                      
            var xReader = new FileReader();                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
            var xJson   = {                                                                                                                                                                                                                                    
                "file": {                                                                                                                                                                                                                                      
                    "chunkSize": xFile.size,                                                                                                                                                                                                                   
                    "size"     : xFile.size,                                                                                                                                                                                                                   
                    "name"     : xFile.name,                                                                                                                                                                                                                   
                    "source"   : aHeader["files"][i]["source"],                                                                                                                                                                                                
                    "type"     : aHeader["files"][i]["type"]                                                                                                                                                                                                   
                },                                                                                                                                                                                                                                             
                "reader"   :  aHeader.reader,                                                                                                                                                                                                                  
                "update"   :  aHeader["files"][i]["update"],                                                                                                                                                                                                   
                "progress" :  aHeader["files"][i]["progress"],                                                                                                                                                                                                 
                "chunkSize":  aHeader.chunkSize                                                                                                                                                                                                                
                };                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
            readOneFile(xJson, xFile);                                                                                                                                                                                                                         
        }                                                                                                                                                                                                                                                      
    }                                                                                                                                                                                                                                                          
}                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
/* Process easy click events         */                                                                                                                                                                                                                        
/* ---------------------------------                                                                                                                                                                                                                           
*/                                                                                                                                                                                                                                                             
function easyClick(aEvent, aElement) {                                                                                                                                                                                                                         
    var aJStr  = decodeURIComponent(aElement.getAttribute("data-eezz-event"));                                                                                                                                                                                 
    var aJson  = eval("(" + aJStr + ")");                                                                                                                                                                                                                      
    var aDest;                                                                                                                                                                                                                                                 
    var aElem;                                                                                                                                                                                                                                                 
    var aPost  = false;                                                                                                                                                                                                                                        
    var aValue;                                                                                                                                                                                                                                                
    var aChunkSize = 65536*2;                                                                                                                                                                                                                                  
    var aClassAttr;                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
    aJson['name'] = aElement['name'];                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
    if (aJson.files) {                                                                                                                                                                                                                                         
        aJson['return'] = {code:0, values:[]};                                                                                                                                                                                                                 
        aJson.chunkSize = aChunkSize;                                                                                                                                                                                                                          
        aPost = true;                                                                                                                                                                                                                                          
    }                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
    /* Generate a callback request */                                                                                                                                                                                                                          
    if (aJson.callback) {                                                                                                                                                                                                                                      
        aPost = true;                                                                                                                                                                                                                                          
        for (xMethod in aJson.callback) {                                                                                                                                                                                                                      
            for (xArg in aJson.callback[xMethod]) {                                                                                                                                                                                                            
                aDest = aJson.callback[xMethod][xArg];                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
                if (typeof aDest === 'string' && aDest.indexOf(".") >= 0) {                                                                                                                                                                                    
                    aDest = aJson.callback[xMethod][xArg].split(".");                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
                    if (aDest[0] == "this") {                                                                                                                                                                                                                  
                        aElem = aElement                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
     }                                                                                                                                                                                                                                                         
                    else {                                                                                                                                                                                                                                     
                        aElem  = document.getElementsByName(aDest[0])[0];                                                                                                                                                                                      
                    }                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
                    aValue = aElem[aDest[1]]                                                                                                                                                                                                                   
                    if (aValue == undefined) {                                                                                                                                                                                                                 
                        aValue = aElem.getAttribute(aDest[1]);                                                                                                                                                                                                 
                    }                                                                                                                                                                                                                                          
                    aJson.callback[xMethod][xArg] = aValue;                                                                                                                                                                                                    
                }                                                                                                                                                                                                                                              
                else {                                                                                                                                                                                                                                         
                    aJson.callback[xMethod][xArg] = aDest;                                                                                                                                                                                                     
                }                                                                                                                                                                                                                                              
            }                                                                                                                                                                                                                                                  
        }                                                                                                                                                                                                                                                      
    }                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
    /* transfer a value from one element to another                */                                                                                                                                                                                          
    /* eezz-agent sets updateValue, if it can't find this property */                                                                                                                                                                                          
    if (aJson.updateValue) {                                                                                                                                                                                                                                   
        for (xSource in aJson.updateValue) {                                                                                                                                                                                                                   
            aSrc     = xSource.split(".")                                                                                                                                                                                                                      
            aSrcElem = document.getElementsByName( aSrc[0] );                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
            if (aSrcElem.length > 0) {                                                                                                                                                                                                                         
                aValu                                                                                                                                                                                                                                          
e  = aSrcElem[0].getAttribute( aSrc[1] );                                                                                                                                                                                                                      
            }                                                                                                                                                                                                                                                  
        }                                                                                                                                                                                                                                                      
    }                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
    /* handle tree node events */                                                                                                                                                                                                                              
    var aTreeElem = null;                                                                                                                                                                                                                                      
    var xParent   = aElement;                                                                                                                                                                                                                                  
    var xPath     = '';                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
    // Calculate path and get tree node for element                                                                                                                                                                                                            
    if (aElement.nodeName == 'TD' || aElement.nodeName == 'TR') {                                                                                                                                                                                              
    	while (xParent != null) {                                                                                                                                                                                                                                 
    		xParent = xParent.parentElement;                                                                                                                                                                                                                         
            if (xParent.className.indexOf('eezzTreeNode') >= 0) {                                                                                                                                                                                              
            	aTreeElem = xParent;                                                                                                                                                                                                                              
            	break;                                                                                                                                                                                                                                            
            }                                                                                                                                                                                                                                                  
            if (xParent.nodeName == 'TABLE' && xParent.className.indexOf('eezzTree') < 0) {                                                                                                                                                                    
            	break;                                                                                                                                                                                                                                            
            }                                                                                                                                                                                                                                                  
    	}                                                                                                                                                                                                                                                         
    }                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
    if (aTreeElem != null) {                                                                                                                                                                                                                                   
        if (aEvent.stopPropagation) {                                                                                                                                                                                                                          
            aEvent.stopPropagation();                                                                                                                                                                                                                          
        }                                                                                                                                                                                                                                                      
        else {                                                                                                                                                                                                                                                 
            aEvent.cancelBubble();                                                                                                                                                                                                                             
        }                                                                                                                                                                                                                                                      
        if (!eezzTreeExCo(aTreeElem)) {                                                                                                                                                                                                                        
        	return;                                                                                                                                                                                                                                               
        }                                                                                                                                                                                                                                                      
    }                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
    if (aJson.update) {                                                                                                                                                                                                                                        
        var aInxKey = 0;                                                                                                                                                                                                                                       
        var aInxVal =                                                                                                                                                                                                                                          
 0;                                                                                                                                                                                                                                                            
        var aNewVal;                                                                                                                                                                                                                                           
        var aNewKey;                                                                                                                                                                                                                                           
        var aElemId;                                                                                                                                                                                                                                           
        var aElemName;                                                                                                                                                                                                                                         
        var xTreeDest;                                                                                                                                                                                                                                         
        var xNewUpdate = {};                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
        if (aTreeElem != null) {                                                                                                                                                                                                                               
        	xPath = aTreeElem.getAttribute('data-eezz-path');                                                                                                                                                                                                     
            if (xPath == null) {                                                                                                                                                                                                                               
            	xPath = ''                                                                                                                                                                                                                                        
            }                                                                                                                                                                                                                                                  
            else {                                                                                                                                                                                                                                             
            	xPath = '.' + xPath;                                                                                                                                                                                                                              
            }                                                                                                                                                                                                                                                  
        }                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
        for (xTreeDest in aJson.update) {                                                                                                                                                                                                                      
            aInxKey  = xTreeDest.indexOf('this.');                                                                                                                                                                                                             
            aInxVal  = aJson.update[ xTreeDest ].indexOf('this.');                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
            aNewVal  = aJson.update[ xTreeDest ];                                                                                                                                                                                                              
            aNewKey  = xTreeDest;                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
            if (aInxVal >= 0) {                                                                                                                                                                                                                                
            	aDest   = aNewVal.split('.');                                                                                                                                                                                                                     
            	aNewVal = aTreeElem.getAttribute('name') + '.' + aDest[1];                                                                                                                                                                                        
            }                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
            if (aInxKey >= 0) {                                                                                                                                                                                                                                
            	aDest    = aNewKey.split(".");                                                                                                                                                                                                                    
            	aNewKey  = aTreeElem.getAttribute('na                                                                                                                                                                                                             
me') + '.' + aDest[1] + xPath;                                                                                                                                                                                                                                 
            }                                                                                                                                                                                                                                                  
            xNewUpdate[ aNewKey ] = aNewVal;                                                                                                                                                                                                                   
        }                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
        aJson.update = xNewUpdate;                                                                                                                                                                                                                             
        aPost        = true;                                                                                                                                                                                                                                   
    }                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
    if (aPost == true) {                                                                                                                                                                                                                                       
        var aResponse = JSON.stringify(aJson);                                                                                                                                                                                                                 
        eezzWebSocket.send(aResponse);                                                                                                                                                                                                                         
    }                                                                                                                                                                                                                                                          
}                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               